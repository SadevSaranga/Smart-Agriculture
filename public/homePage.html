<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Green Pulse | Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      padding-top: 70px;
      padding-bottom: 100px;
    }
    .profile-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #28a745;
    }
    .card {
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    footer {
      background-color: rgb(20, 45, 21);
    }
    footer a {
      color: white;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .user-email {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logout-btn {
      margin-left: 15px;
    }
  </style>
</head>

<body>
  <!-- Top Header -->
  <div data-include="Navbar.html" class="col-12"></div>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h3>Hi, <span id="username">User</span> üëã</h3>
        <p class="user-email mb-0" id="userEmail">Loading...</p>
      </div>
      <div class="user-info">
        <img src="https://via.placeholder.com/50" alt="User DP" class="profile-img" id="userDP" />
        <button class="btn btn-sm btn-outline-danger logout-btn" id="logoutBtn" style="display: none;">Logout</button>
      </div>
    </div>
  </div>

  <!-- Company Images / Widgets -->
  <div class="container mt-4">
    <div class="row g-3">
      <p class="justify-content-center">Our Smart Agriculture System offers tailored packages to meet the diverse needs
        of modern farming environments. Green Field A is designed for well-irrigated zones, ensuring continuous
        monitoring of soil and environmental conditions to maintain optimal crop growth. Farm 2 ‚Äì Field B focuses on
        dry-zone cultivation and operates under advanced water-conservation monitoring, helping farmers manage limited
        resources efficiently. Farm 3 ‚Äì Green House C supports a climate-controlled greenhouse, providing intelligent
        temperature, humidity, and moisture management for high-value or sensitive crops.</p>
      
      <!-- Card 1 -->
      <div class="col-md-4">
        <div class="card">
          <img src="https://imgs.search.brave.com/L6Db6cpYcBOrDZcrf-d_y1IZP29GPIIcsDCyJ5oz9hI/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL0kv/ODE0QmZDKzlqNkwu/anBn"
            class="card-img-top p-5 offset-1" style="width: 350px; height: 300px; " alt="Farm 1" />
          <div class="card-body">
            <h5 class="card-title">Wet Zone</h5>
            <p class="card-text">Well-irrigated zone</p>
          </div>
        </div>
      </div>
      
      <!-- Card 2 -->
      <div class="col-md-4">
        <div class="card">
          <img src="https://imgs.search.brave.com/p5xRounQrw4TFC4YZtkIFX8FdZS6kouFp8VcpBD09B8/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL0kv/ODFnQUpkaUxpbkwu/anBn"
            class="card-img-top p-5" style="width: 400px; height: 300px; " alt="Farm 2" />
          <div class="card-body">
            <h5 class="card-title">Dry Zone</h5>
            <p class="card-text">Under water-conservation monitoring.</p>
          </div>
        </div>
      </div>
      
      <!-- Card 3 -->
      <div class="col-md-4">
        <div class="card">
          <img src="https://imgs.search.brave.com/5gcjyGIfbdySq6tyMhXvgYjhS2qeUeLeWhAhnKQq7gE/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9pbWcu/ZnJlZXBpay5jb20v/cHJlbWl1bS1waG90/by9zbWFydC1ncmVl/bmhvdXNlLXN5c3Rl/bS13aXRoLWNsaW1h/dGUtY29udHJvbC10/ZWNobm9sb2d5XzE5/ODA2Ny0xMjU1MDE1/LmpwZz9zZW10PWFp/c19oeWJyaWQmdz03/NDA"
            class="card-img-top p-5" style="width: 400px; height: 300px;" alt="Farm 3" />
          <div class="card-body">
            <h5 class="card-title">Green House</h5>
            <p class="card-text">Climate-controlled greenhouse</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Form to Select Field/Crop -->
  <div class="container mt-5">
    <div class="card p-4">
      <h4>Select Ground & Crop Details</h4>
      <form id="moistureForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="product_ID" class="form-label">Enter Product ID</label>
            <input type="text" class="form-control" id="product_ID" placeholder="e.g. P2389" required />
            <small class="text-muted">Enter the product/field identifier</small>
          </div>
          <div class="col-md-6">
            <label for="moisture" class="form-label">Required Moisture (%)</label>
            <input type="number" class="form-control" id="moisture" placeholder="e.g. 50" min="0" max="100" required />
            <small class="text-muted">Value between 0-100</small>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-success">
            Update & Go to Dashboard
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading/Status Indicators -->
  <div class="container mt-3">
    <div id="loadingIndicator" class="alert alert-info d-none" role="alert">
      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
      Updating moisture threshold...
    </div>
    <div id="successIndicator" class="alert alert-success d-none" role="alert">
      ‚úÖ Moisture threshold updated successfully!
    </div>
    <div id="errorIndicator" class="alert alert-danger d-none" role="alert">
      <strong>‚ùå Error:</strong> <span id="errorMessage">Could not update threshold</span>
      <br><small id="errorDetails" class="mt-2"></small>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="container mt-2">
    <div id="connectionStatus" class="alert alert-warning d-none" role="alert">
      üîå Checking Firebase connection...
    </div>
  </div>

  <!-- Footer -->
  <footer class="container-fluid text-white mt-5 fixed-bottom">
    <div class="text-center py-3 border-top">
      &copy; 2024 Green Pulse | All rights reserved.
      <a href="privacy.html" class="text-reset">Privacy Policy</a> |
      <a href="terms.html" class="text-reset">Terms of Service</a>
    </div>
  </footer>

  <script>
    function includeHTML() {
      const elements = document.querySelectorAll('[data-include]');

      elements.forEach(element => {
        const file = element.getAttribute('data-include');

        if (file) {
          fetch(file)
            .then(response => {
              if (response.ok) {
                return response.text();
              }
              throw new Error('File not found: ' + file);
            })
            .then(data => {
              element.innerHTML = data;
            })
            .catch(error => {
              console.error('Error loading file:', error);
              element.innerHTML = '<p>Content could not be loaded.</p>';
            });
        }
      });
    }
  </script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCmtglyxNbz94KGLMRqMDFDDmAtNntquBs",
      authDomain: "smart-agriculture-system-fe7c6.firebaseapp.com",
      databaseURL: "https://smart-agriculture-system-fe7c6-default-rtdb.firebaseio.com",
      projectId: "smart-agriculture-system-fe7c6",
      storageBucket: "smart-agriculture-system-fe7c6.appspot.com",
      messagingSenderId: "1052704207717",
      appId: "1:1052704207717:web:c89592a504d5fd11d7678c"
    };

    let database;
    let auth;
    let isConnected = false;
    let currentUser = null;

    // Initialize Firebase
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase initialized successfully");
      }
      database = firebase.database();
      auth = firebase.auth();

      // Test connection
      const connectedRef = database.ref(".info/connected");
      connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
          console.log("‚úÖ Connected to Firebase");
          isConnected = true;
          hideConnectionStatus();
        } else {
          console.log("‚ùå Disconnected from Firebase");
          isConnected = false;
          showConnectionStatus("Reconnecting to Firebase...");
        }
      });

    } catch (error) {
      console.error("‚ùå Firebase initialization error:", error);
      showError("Firebase initialization failed", error.message);
    }

    // Authentication State Observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        displayUserInfo(user);
        console.log("‚úÖ User logged in:", user.email);
      } else {
        console.log("‚ö†Ô∏è No user logged in");
        // Redirect to login page or show login prompt
        // window.location.href = "login.html";
        displayGuestInfo();
      }
    });

    // Display User Information
    function displayUserInfo(user) {
      // Display user's display name or email
      const displayName = user.displayName || user.email.split('@')[0];
      document.getElementById('username').textContent = displayName;
      
      // Display user's email
      document.getElementById('userEmail').textContent = user.email;
      
      // Display user's photo
      if (user.photoURL) {
        document.getElementById('userDP').src = user.photoURL;
      } else {
        // If no photo, use a default avatar with user's initial
        const initial = displayName.charAt(0).toUpperCase();
        document.getElementById('userDP').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=28a745&color=fff&size=50`;
      }
      
      // Show logout button
      document.getElementById('logoutBtn').style.display = 'block';
    }

    // Display Guest Information (if not logged in)
    function displayGuestInfo() {
      document.getElementById('username').textContent = 'Guest';
      document.getElementById('userEmail').textContent = 'Not logged in';
      document.getElementById('userDP').src = 'https://ui-avatars.com/api/?name=Guest&background=6c757d&color=fff&size=50';
      document.getElementById('logoutBtn').style.display = 'none';
    }

    // Logout Handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      auth.signOut().then(() => {
        console.log("‚úÖ User logged out");
        alert("You have been logged out successfully!");
        // Redirect to login page
        // window.location.href = "login.html";
      }).catch((error) => {
        console.error("‚ùå Logout error:", error);
        alert("Error logging out: " + error.message);
      });
    });

    // Show/Hide Status Indicators
    function showLoading() {
      document.getElementById('loadingIndicator').classList.remove('d-none');
      document.getElementById('successIndicator').classList.add('d-none');
      document.getElementById('errorIndicator').classList.add('d-none');
    }

    function showSuccess() {
      document.getElementById('loadingIndicator').classList.add('d-none');
      document.getElementById('successIndicator').classList.remove('d-none');
      document.getElementById('errorIndicator').classList.add('d-none');
    }

    function showError(message, details = '') {
      document.getElementById('loadingIndicator').classList.add('d-none');
      document.getElementById('successIndicator').classList.add('d-none');
      document.getElementById('errorIndicator').classList.remove('d-none');
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorDetails').textContent = details;
    }

    function hideAllIndicators() {
      document.getElementById('loadingIndicator').classList.add('d-none');
      document.getElementById('successIndicator').classList.add('d-none');
      document.getElementById('errorIndicator').classList.add('d-none');
    }

    function showConnectionStatus(message) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.textContent = 'üîå ' + message;
      statusEl.classList.remove('d-none');
    }

    function hideConnectionStatus() {
      document.getElementById('connectionStatus').classList.add('d-none');
    }

    // Form submission handler
    document.getElementById('moistureForm').addEventListener('submit', function(e) {
      e.preventDefault();
      updateValues();
    });

    // Main update function
    function updateValues() {
      const moistureInput = document.getElementById("moisture").value;
      const productID = document.getElementById("product_ID").value.trim();

      // Validation
      if (!productID) {
        alert("‚ö†Ô∏è Please enter a Product ID");
        return;
      }

      const moisture = parseInt(moistureInput);
      if (isNaN(moisture) || moisture < 0 || moisture > 100) {
        alert("‚ö†Ô∏è Moisture value must be between 0 and 100");
        return;
      }

      // Check if user is logged in
      if (!currentUser) {
        alert("‚ö†Ô∏è Please log in to update moisture values");
        return;
      }

      // Check connection
      if (!isConnected) {
        showError("Not connected to Firebase", "Please check your internet connection and try again.");
        return;
      }

      // Show loading
      showLoading();

      // Store locally
      localStorage.setItem('productID', productID);
      localStorage.setItem('moisture', moisture);

      // Update Firebase
      updateMoistureThreshold(productID, moisture);
    }

    // Firebase update function
    function updateMoistureThreshold(productID, threshold) {
      const productRef = database.ref(productID);

      console.log("Writing to Firebase path:", productID);

      productRef.set({
        moisture_threshold: threshold,
        moisture_live: threshold,
        last_updated: new Date().toISOString(),
        updated_by: currentUser ? currentUser.email : 'unknown'
      })
      .then(() => {
        console.log("‚úÖ Data saved successfully!");
        showSuccess();
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1500);
      })
      .catch((error) => {
        console.error("‚ùå Firebase Error:", error);
        showError("Failed to update moisture threshold", error.message);
      });
    }

    // Load saved values if available
    window.addEventListener('load', function() {
      const savedProductID = localStorage.getItem('productID');
      const savedMoisture = localStorage.getItem('moisture');

      if (savedProductID) {
        document.getElementById('product_ID').value = savedProductID;
      }
      if (savedMoisture) {
        document.getElementById('moisture').value = savedMoisture;
      }
    });
  </script>
</body>

</html>